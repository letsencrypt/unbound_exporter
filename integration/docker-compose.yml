services:
  # Setup container that generates certificates
  setup:
    image: debian:forky
    volumes:
      - certs:/certs
      - ./setup-certs.sh:/setup-certs.sh:ro
    command: ["sh", "-c", "apt-get update && apt-get install -y openssl && bash /setup-certs.sh"]

  unbound_exporter:
    build:
      context: ..
    environment:
      - EXPORTER_COMMAND
    volumes:
      - socket:/var/run/socket:ro
      - certs:/certs:ro
      - ./start-exporter.sh:/start-exporter.sh:ro
    entrypoint: ["/bin/sh", "/start-exporter.sh"]
    ports:
      - "9167:9167"
    depends_on:
      setup:
        condition: service_completed_successfully
      unbound:
        condition: service_started

  unbound:
    build:
      context: .
      dockerfile: unbound.Containerfile
    environment:
      - UNBOUND_CONFIG
    volumes:
      - socket:/var/run/socket:rw
      - certs:/certs:ro
      - ./setup-unbound-config.sh:/setup-unbound-config.sh:ro
    command: ["bash", "/setup-unbound-config.sh"]
    ports:
      - "1053:1053/udp"
      - "1053:1053/tcp"
      - "2853:2853/tcp" # DoQ
      - "8953:8953"
      - "8954:8954"
    depends_on:
      setup:
        condition: service_completed_successfully

volumes:
  socket:
  certs:


